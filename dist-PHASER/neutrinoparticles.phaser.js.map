{"version":3,"sources":["PhaserNeutrinoContext.js","PhaserNeutrinoEffect.js","PhaserNeutrinoEffectModel.js","PhaserNeutrinoMaterials.js","PhaserNeutrinoRenderBuffers.js"],"names":["PhaserNeutrinoContext","renderer","gl","neutrino","NeutrinoParticles","effectsBasePath","texturesBasePath","trimmedExtensionLookupFirst","PIXI","CanvasRenderer","materials","PhaserNeutrinoMaterials","path","success","fail","initializeNoise","loadEffect","PhaserNeutrinoEffect","effectModel","position","game","rotation","scale","_renderCanvas","renderCanvas","_renderWebGL","renderWebGL","ctx","effect","set","positionZ","onReady","Phaser","Signal","x","y","scaleZ","ready","_onEffectReady","addOnce","dt","update","axisangle2quat_","context","setTransform","draw","defaultShader","shaderManager","setShader","renderSession","projection","offset","uniform2f","projectionVector","offsetVector","projectionMatrix","setup","fillGeometryBuffers","renderBuffers","updateGlBuffers","bind","renderCallIdx","numRenderCalls","renderCall","renderCalls","texIndex","model","renderStyles","renderStyleIndex","textureIndices","updateTexture","textures","materialIndex","switchToNormal","switchToAdd","switchToMultiply","drawElements","TRIANGLES","numIndices","UNSIGNED_SHORT","startIndex","restart","resetPosition","name","value","setPropertyInAllEmitters","getNumParticles","console","log","type","CANVAS_RENDERER","createCanvas2DInstance","textureDescs","textureImageDescs","PhaserNeutrinoRenderBuffers","createWGLInstance","texturesRemap","dispatch","Group","PhaserNeutrinoEffectModel","effectPath","numTexturesToLoadLeft","pixiNeutrinoEffect","_onEffectLoaded","id","replace","imageData","cache","_cache","image","baseTexture","base","Texture","frame","numTextures","length","imageIndex","texturePath","texture","_getNewTexture","fromImage","hasLoaded","_onTextureLoaded","callback","self","off","on","index","source","ImageDesc","orig","width","height","WEBGL_RENDERER","_initTexturesRemapIfNeeded","remapNeeded","texIdx","realWidth","realHeight","n","SubRect","Sprite","vertexShaderSource","fragmentShaderSource","fragmentShaderMultiplySource","shaderProgram","_makeShaderProgram","shaderProgramMultiply","pMatrix","currentProgram","vertexPositionAttribute","colorAttribute","textureCoordAttribute","slice","_setProgram","blendModeManager","setBlendMode","program","useProgram","uniformMatrix3fv","pMatrixUniform","uniform1i","samplerUniform","scaleUniform","vertexShader","createShader","VERTEX_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","alert","getShaderInfoLog","fragmentShader","FRAGMENT_SHADER","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getAttribLocation","getUniformLocation","geometryBuffers","positions","colors","texCoords","maxNumVertices","numVertices","indices","maxNumRenderCalls","texChannels","Float32Array","ArrayBuffer","Uint8Array","texChannel","numComponents","Uint16Array","positionBuffer","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","DYNAMIC_DRAW","colorBuffer","texBuffers","buffer","push","indicesBuffer","ELEMENT_ARRAY_BUFFER","STATIC_DRAW","vertex","color","rc","Object","assign","bufferSubData","forEach","enableVertexAttribArray","positionAttribLocation","vertexAttribPointer","FLOAT","colorAttribLocation","UNSIGNED_BYTE","texAttribLocation","deleteBuffer"],"mappings":"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","file":"neutrinoparticles.phaser.js","sourcesContent":["class PhaserNeutrinoContext {\n\n  constructor(renderer) {\n    var gl = renderer.gl;\n\n    this.renderer = renderer;\n    this.neutrino = new NeutrinoParticles();\n    this.effectsBasePath = \"\";\n    this.texturesBasePath = \"\";\n    this.trimmedExtensionLookupFirst = true;\n\n    if (!(renderer instanceof PIXI.CanvasRenderer)) {\n      this.materials = new PhaserNeutrinoMaterials(gl);\n    }\n  }\n\n  initializeNoise(path, success, fail) {\n    this.neutrino.initializeNoise(path, success, fail);\n  }\n\n  loadEffect(path, success, fail) {\n    this.neutrino.loadEffect(path, success, fail);\n  }\n}","class PhaserNeutrinoEffect extends Phaser.Group {\n\n  constructor(effectModel, position, game, rotation, scale) {\n    super(game, null);\n\n    this._renderCanvas = this.renderCanvas;\n    this._renderWebGL = this.renderWebGL;\n\n    this.ctx = effectModel.ctx;\n    this.effectModel = effectModel;\n    this.effect = null;\n    this.position.set(position[0], position[1]);\n    this.positionZ = position[2];\n\n    this.onReady = new Phaser.Signal();\n\n    if (rotation)\n      this.rotation = rotation;\n\n    if (scale) {\n      this.scale.x = scale[0];\n      this.scale.y = scale[1];\n      this.scaleZ = scale[2];\n    }\n    else\n      this.scaleZ = 1;\n\n    if (effectModel.ready()) {\n      this._onEffectReady();\n    } else {\n      effectModel.onReady.addOnce(function () {\n        this._onEffectReady();\n      }, this);\n    }\n  }\n\n  ready() {\n    return this.effect !== null;\n  }\n\n  updateParticles(dt) {\n    if (this.effect !== null) {\n      this.effect.update(dt, [this.position.x / this.scale.x, this.position.y / this.scale.y, this.positionZ / this.scaleZ],\n        this.ctx.neutrino.axisangle2quat_([0, 0, 1], this.rotation % 360));\n    }\n  }\n\n  renderCanvas(renderer) {\n    if (!this.ready())\n      return;\n\n    renderer.context.setTransform(this.scale.x, 0, 0, this.scale.y, 0, 0);\n    this.effect.draw(renderer.context);\n  };\n\n  renderWebGL(renderer) {\n    if (!this.ready())\n      return;\n\n    var gl = renderer.gl;\n\n    /*\n    renderer.setObjectRenderer(renderer.emptyRenderer);\n    renderer.bindVao(null);\n    renderer.state.resetAttributes();\n\n    renderer.state.push();\n    renderer.state.setState(renderer.state.defaultState);*/\n\n    // hack! the only way to discard current shader for futher engine rendering\n    //renderer._activeShader = null;\n\n    //---- from pixi.js filterManager ------------\n    // update projection\n    // now restore the regular shader..\n    // this.renderSession.shaderManager.setShader(this.defaultShader);\n    //gl.uniform2f(this.defaultShader.projectionVector, filterArea.width/2, -filterArea.height/2);\n    //gl.uniform2f(this.defaultShader.offsetVector, -filterArea.x, -filterArea.y);\n    // -----------------------------------\n    const defaultShader = game.renderer.shaderManager.defaultShader;\n    game.renderer.shaderManager.setShader(defaultShader);\n\n    const renderSession = game.renderer.renderSession;\n    const projection = renderSession.projection,\n      offset = renderSession.offset;\n    gl.uniform2f(defaultShader.projectionVector, projection.x, -projection.y);\n    gl.uniform2f(defaultShader.offsetVector, -offset.x, -offset.y);\n\n    // - _activeRenderTarget doesn't exist in this version of pixi\n    // var target = renderer._activeRenderTarget;\n    //console.log('projectionVector', defaultShader.projectionVector, 'offsetVector', defaultShader.offsetVector)\n    //projectionMatrix doesn't exist in this version of pixi\n\n    /* Matrix.ToArray\n    array[0] = this.a; > x scale\n    array[1] = this.c; > x skew\n    array[2] = this.tx;\n    array[3] = this.b; > y skew\n    array[4] = this.d; > y scale\n    array[5] = this.ty;\n    array[6] = 0;\n    array[7] = 0;\n    array[8] = 1;\n     */\n    const projectionMatrix = [1, 0, 0, 1, 0, 0, 0, 0, 1];\n    // const projectionMatrix = [0.0025, 0, 0, 0, -0.0033333334140479565, 0, -1, 1, 1];\n    //TODO - set transform and scale values appropriately on projectionMatrix\n\n\n    // this.ctx.materials.setup(target.projectionMatrix.toArray(true), [this.scale.x, this.scale.y]);\n    this.ctx.materials.setup(projectionMatrix, [this.scale.x, this.scale.y]);\n\n    this.effect.fillGeometryBuffers([1, 0, 0], [0, -1, 0], [0, 0, -1]);\n\n    this.renderBuffers.updateGlBuffers();\n    this.renderBuffers.bind();\n\n    for (let renderCallIdx = 0; renderCallIdx < this.renderBuffers.numRenderCalls; ++renderCallIdx) {\n      const renderCall = this.renderBuffers.renderCalls[renderCallIdx];\n      const texIndex = this.effect.model.renderStyles[renderCall.renderStyleIndex].textureIndices[0];\n\n      // - bindTexture doesn't exist in this version of pixi\n      //try updateTexture instead\n      // renderer.bindTexture(this.effectModel.textures[texIndex], 0, true);\n      game.renderer.updateTexture(this.effectModel.textures[texIndex]);//, 0, true);\n\n      const materialIndex = this.effect.model.renderStyles[renderCall.renderStyleIndex].materialIndex;\n      switch (this.effect.model.materials[materialIndex]) {\n        default: this.ctx.materials.switchToNormal(renderer); break;\n        case 1: this.ctx.materials.switchToAdd(renderer); break;\n        case 2: this.ctx.materials.switchToMultiply(renderer); break;\n      }\n\n      gl.drawElements(gl.TRIANGLES, renderCall.numIndices, gl.UNSIGNED_SHORT, renderCall.startIndex * 2);\n    }\n\n    //renderer.state.pop();\n\n  }\n\n  restart(position, rotation) {\n    if (position) {\n      this.position.x = position[0];\n      this.position.y = position[1];\n      this.positionZ = position[2];\n    }\n\n    if (rotation) {\n      this.rotation = rotation;\n    }\n\n    this.effect.restart([this.position.x / this.scale.x, this.position.y / this.scale.y, this.positionZ / this.scaleZ],\n      rotation ? this.ctx.neutrino.axisangle2quat_([0, 0, 1], rotation % 360) : null);\n  }\n\n  resetPosition(position, rotation) {\n    if (position) {\n      this.position.x = position[0];\n      this.position.y = position[1];\n      this.positionZ = position[2];\n    }\n\n    if (rotation) {\n      this.rotation = rotation;\n    }\n\n    this.effect.resetPosition([this.position.x / this.scale.x, this.position.y / this.scale.y, this.positionZ / this.scaleZ],\n      rotation ? this.ctx.neutrino.axisangle2quat_([0, 0, 1], rotation % 360) : null);\n  }\n\n  setPropertyInAllEmitters(name, value) {\n    this.effect.setPropertyInAllEmitters(name, value);\n  }\n\n  getNumParticles() {\n    return this.effect.getNumParticles();\n  }\n\n  _onEffectReady() {\n    console.log('Effect ready')\n    var position = [this.position.x / this.scale.x, this.position.y / this.scale.y, this.positionZ / this.scaleZ];\n    var rotation = this.ctx.neutrino.axisangle2quat_([0, 0, 1], this.rotation % 360);\n\n    if (this.effectModel.ctx.renderer.type === Phaser.PIXI.CANVAS_RENDERER) {\n      this.effect = this.effectModel.effectModel.createCanvas2DInstance(position, rotation);\n      this.effect.textureDescs = this.effectModel.textureImageDescs;\n    } else {\n      this.renderBuffers = new PhaserNeutrinoRenderBuffers(this.ctx);\n      this.effect = this.effectModel.effectModel.createWGLInstance(position, rotation, this.renderBuffers);\n      this.effect.texturesRemap = this.effectModel.texturesRemap;\n    }\n\n    //this.emit('ready', this);\n    this.onReady.dispatch();\n  }\n}","class PhaserNeutrinoEffectModel extends Phaser.Sprite {\n\n  constructor(context, effectPath, game) {\n    super(game);\n\n    this.ctx = context;\n    this.effectPath = effectPath;\n    this.effectModel = null;\n    this.numTexturesToLoadLeft = -1;\n    this.texturesRemap = null;\n\n    this.onReady = new Phaser.Signal();\n\n    var pixiNeutrinoEffect = this;\n    this.ctx.neutrino.loadEffect(this.ctx.effectsBasePath + effectPath, function (effectModel) {\n      pixiNeutrinoEffect._onEffectLoaded(effectModel);\n    });\n  }\n\n  ready() {\n    return this.numTexturesToLoadLeft === 0;\n  }\n\n  _getNewTexture(id){\n    if (this.ctx.trimmedExtensionLookupFirst) id = id.replace(/\\.[^/.]+$/, \"\");\n    //TODO - see if theres a better way of accessing this...\n    const imageData = game.cache._cache.image[id];\n    const baseTexture = imageData.base;\n    return new Phaser.PIXI.Texture(baseTexture, imageData.frame);\n  }\n\n  _onEffectLoaded(effectModel) {\n    this.effectModel = effectModel;\n    this.textures = [];\n    this.textureImageDescs = [];\n    const numTextures = effectModel.textures.length;\n    this.numTexturesToLoadLeft = numTextures;\n\n    for (let imageIndex = 0; imageIndex < numTextures; ++imageIndex) {\n      const texturePath = effectModel.textures[imageIndex];\n      let texture = this._getNewTexture(texturePath);\n\n      if (!texture)\n      //TODO - fix this\n        texture = PIXI.Texture.fromImage(this.ctx.texturesBasePath + texturePath);\n\n      if (texture.baseTexture.hasLoaded) {\n        this._onTextureLoaded(imageIndex, texture);\n      } else {\n        const callback = function (self, imageIndex, texture) {\n          texture.off('update', callback);\n          return function () {\n            self._onTextureLoaded(imageIndex, texture);\n          }\n        } (this, imageIndex, texture);\n\n        texture.on('update', callback);\n      }\n\n    }\n  }\n\n  _onTextureLoaded(index, texture) {\n    this.textures[index] = texture;\n\n    this.numTexturesToLoadLeft--;\n\n    if (this.ctx.renderer.type === Phaser.PIXI.CANVAS_RENDERER) {\n      const image = texture.baseTexture.source;\n      //TODO - texture.orig doesn't exist in this version of pixi...\n      this.textureImageDescs[index] = new this.ctx.neutrino.ImageDesc(image, texture.orig.x, texture.orig.y,\n        texture.orig.width, texture.orig.height);\n    }\n\n    if (this.numTexturesToLoadLeft === 0) {\n\n      if(this.ctx.renderer.type === Phaser.PIXI.WEBGL_RENDERER){\n        this._initTexturesRemapIfNeeded();\n      }\n      //this.emit('ready', this);\n      this.onReady.dispatch();\n    }\n  }\n\n  _initTexturesRemapIfNeeded() {\n    let remapNeeded = false;\n\n    for (var texIdx = 0; texIdx < this.textures.length; ++texIdx) {\n      const texture = this.textures[texIdx];\n      //checks if its an atlas subtexture\n      if (texture.orig && (texture.orig.x !== 0 || texture.orig.y !== 0\n          || texture.orig.width !== texture.baseTexture.realWidth\n          || texture.orig.height !== texture.baseTexture.realHeight)) {\n        remapNeeded = true;\n        break;\n      }\n    }\n\n    this.texturesRemap = [];\n    if (remapNeeded) {\n      const n = this.textures.length;\n      for (let texIdx = 0; texIdx < n; ++texIdx) {\n        const texture = this.textures[texIdx];\n\n        this.texturesRemap[texIdx] = new this.ctx.neutrino.SubRect(\n          texture.orig.x / texture.baseTexture.realWidth,\n          1.0 - (texture.orig.y + texture.orig.height) / texture.baseTexture.realHeight,\n          texture.orig.width / texture.baseTexture.realWidth,\n          texture.orig.height / texture.baseTexture.realHeight\n        );\n      }\n    }\n  }\n}","class PhaserNeutrinoMaterials {\n\n  constructor(gl) {\n    this.gl = gl;\n\n    var vertexShaderSource = \"\\\n\t\t\tattribute vec3 aVertexPosition;\\\n\t\t\tattribute vec4 aColor; \\\n\t\t\tattribute vec2 aTextureCoord;\\\n\t\t\t\\\n\t\t\tuniform mat3 projectionMatrix;\\\n\t\t\tuniform vec2 scale;\\\n\t\t\t\\\n\t\t\tvarying vec4 vColor;\\\n\t\t\tvarying vec2 vTextureCoord;\\\n\t\t\t\\\n\t\t\tvoid main(void) {\\\n\t\t\t\tgl_Position = vec4((projectionMatrix * vec3(aVertexPosition.xy * scale, 1.0)).xy, 0, 1);\\\n\t\t\t\tvColor = vec4(aColor.rgb * aColor.a, aColor.a);\\\n\t\t\t\tvTextureCoord = vec2(aTextureCoord.x, 1.0 - aTextureCoord.y);\\\n\t\t\t}\";\n\n    var fragmentShaderSource = \"\\\n\t\t\tprecision mediump float;\\\n\t\t\t\\\n\t\t\tvarying vec4 vColor;\\\n\t\t\tvarying vec2 vTextureCoord;\\\n\t\t\\\n\t\t\tuniform sampler2D uSampler;\\\n\t\t\t\\\n\t\t\tvoid main(void) {\\\n\t\t\t\tgl_FragColor = vColor * texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\\\n\t\t\t}\";\n\n    var fragmentShaderMultiplySource = \"\\\n\t\t\tprecision mediump float;\\\n\t\t\t\\\n\t\t\tvarying vec4 vColor;\\\n\t\t\tvarying vec2 vTextureCoord;\\\n\t\t\t\\\n\t\t\tuniform sampler2D uSampler;\\\n\t\t\t\\\n\t\t\tvoid main(void)\\\n\t\t\t{\\\n\t\t\t\tvec4 texel = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\\\n\t\t\t\tvec3 rgb = vColor.rgb * texel.rgb;\\\n\t\t\t\tfloat alpha = vColor.a * texel.a;\\\n\t\t\t\tgl_FragColor = vec4(mix(vec3(1, 1, 1), rgb, alpha), 1);\\\n\t\t\t}\";\n\n    this.shaderProgram = this._makeShaderProgram(vertexShaderSource, fragmentShaderSource);\n    this.shaderProgramMultiply = this._makeShaderProgram(vertexShaderSource, fragmentShaderMultiplySource);\n\n    this.pMatrix = null;\n    this.currentProgram = null;\n  }\n\n  shutdown() {\n  }\n\n  positionAttribLocation() {\n    return this.shaderProgram.vertexPositionAttribute;\n  }\n\n  colorAttribLocation() {\n    return this.shaderProgram.colorAttribute;\n  }\n\n  texAttribLocation(index) {\n    return this.shaderProgram.textureCoordAttribute[index];\n  }\n\n  setup(pMatrix, scale) {\n    // console.log('PIXINeutrinoMaterials setup', pMatrix)\n    // var gl = this.gl;\n\n    this.pMatrix = pMatrix;\n    this.scale = scale.slice();\n    this.currentProgram = null;\n  }\n\n  switchToNormal(renderer) {\n    this._setProgram(this.shaderProgram);\n    renderer.blendModeManager.setBlendMode(0);\n  }\n\n  switchToAdd(renderer) {\n    this._setProgram(this.shaderProgram);\n    renderer.blendModeManager.setBlendMode(1);\n  }\n\n  switchToMultiply(renderer) {\n    this._setProgram(this.shaderProgramMultiply);\n    renderer.blendModeManager.setBlendMode(2);\n  }\n\n  _setProgram(program) {\n    var gl = this.gl;\n\n    if (program !== this.currentProgram) {\n      gl.useProgram(program);\n      // console.log('_setProgram',program.pMatrixUniform, this.pMatrix)\n      gl.uniformMatrix3fv(program.pMatrixUniform, false, this.pMatrix);\n      gl.uniform1i(program.samplerUniform, 0);\n      gl.uniform2f(program.scaleUniform, this.scale[0], this.scale[1]);\n\n      this.currentProgram = program;\n    }\n  }\n\n  _makeShaderProgram(vertexShaderSource, fragmentShaderSource) {\n    var gl = this.gl;\n\n    var vertexShader = gl.createShader(gl.VERTEX_SHADER);\n    gl.shaderSource(vertexShader, vertexShaderSource);\n    gl.compileShader(vertexShader);\n\n    if (!gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) {\n      alert(gl.getShaderInfoLog(vertexShader));\n      return null;\n    }\n\n    var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);\n    gl.shaderSource(fragmentShader, fragmentShaderSource);\n    gl.compileShader(fragmentShader);\n\n    if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {\n      alert(gl.getShaderInfoLog(fragmentShader));\n      return null;\n    }\n\n    var shaderProgram = gl.createProgram();\n    gl.attachShader(shaderProgram, vertexShader);\n    gl.attachShader(shaderProgram, fragmentShader);\n    gl.linkProgram(shaderProgram);\n\n    if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {\n      alert(\"Could not initialise shaders\");\n    }\n\n    gl.useProgram(shaderProgram);\n\n    shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, \"aVertexPosition\");\n    shaderProgram.colorAttribute = gl.getAttribLocation(shaderProgram, \"aColor\");\n    shaderProgram.textureCoordAttribute = [gl.getAttribLocation(shaderProgram, \"aTextureCoord\")];\n\n    shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, \"projectionMatrix\");\n    shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, \"uSampler\");\n    shaderProgram.scaleUniform = gl.getUniformLocation(shaderProgram, \"scale\");\n\n    return shaderProgram;\n  }\n}","class PhaserNeutrinoRenderBuffers {\n  constructor(context, geometryBuffers) {\n    this.ctx = context;\n    this.gl = this.ctx.renderer.gl;\n\n    this.positions = null;\n    this.colors = null;\n    this.texCoords = [];\n    this.maxNumVertices = 0;\n    this.numVertices = 0;\n    this.indices = null;\n\n    this.renderCalls = [];\n    this.maxNumRenderCalls = 0;\n    this.numRenderCalls = 0;\n  }\n\n  initialize(maxNumVertices, texChannels, indices, maxNumRenderCalls) {\n    var gl = this.gl;\n\n    this.positions = new Float32Array(new ArrayBuffer(4 * maxNumVertices * 3));\n    this.colors = new Uint8Array(new ArrayBuffer(4 * maxNumVertices));\n    this.texCoords = [];\n    for (var texChannel = 0; texChannel < texChannels.length; ++texChannel) {\n      this.texCoords[texChannel] = new Float32Array(new ArrayBuffer(4 * maxNumVertices * texChannels[texChannel]));\n      this.texCoords[texChannel].numComponents = texChannels[texChannel];\n    }\n    this.maxNumVertices = maxNumVertices;\n\n    this.indices = new Uint16Array(new ArrayBuffer(2 * indices.length));\n    this.indices.set(indices, 0);\n\n    this.maxNumRenderCalls = maxNumRenderCalls;\n\n    this.positionBuffer = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, this.positions, gl.DYNAMIC_DRAW);\n\n    this.colorBuffer = gl.createBuffer();\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.colorBuffer);\n    gl.bufferData(gl.ARRAY_BUFFER, this.colors, gl.DYNAMIC_DRAW);\n\n    this.texBuffers = [];\n    for (var texIndex = 0; texIndex < this.texCoords.length; ++texIndex) {\n      var buffer = gl.createBuffer();\n      gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\n      gl.bufferData(gl.ARRAY_BUFFER, this.texCoords[texIndex], gl.DYNAMIC_DRAW);\n      this.texBuffers.push(buffer);\n    }\n\n    this.indicesBuffer = gl.createBuffer();\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indicesBuffer);\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.indices, gl.STATIC_DRAW);\n  }\n\n  pushVertex(vertex) {\n    this.positions.set(vertex.position, this.numVertices * 3);\n    this.colors.set(vertex.color, this.numVertices * 4);\n\n    for (var texIndex = 0; texIndex < vertex.texCoords.length; ++texIndex) {\n      this.texCoords[texIndex].set(vertex.texCoords[texIndex],\n        this.numVertices * this.texCoords[texIndex].numComponents);\n    }\n\n    ++this.numVertices;\n  }\n\n  pushRenderCall(rc) {\n\n    if (this.numRenderCalls >= this.renderCalls.length)\n      this.renderCalls.push(Object.assign({}, rc));\n    else\n      Object.assign(this.renderCalls[this.numRenderCalls], rc);\n\n    ++this.numRenderCalls;\n  }\n\n  cleanup() {\n    this.numVertices = 0;\n    this.numRenderCalls = 0;\n  }\n\n  updateGlBuffers() {\n    var gl = this.gl;\n\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n    gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.positions, 0, this.numVertices * 3);\n\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.colorBuffer);\n    gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.colors, 0, this.numVertices * 4);\n\n    this.texBuffers.forEach(function (buffer, index) {\n      gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\n      gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.texCoords[index], 0, this.numVertices *\n        this.texCoords[index].numComponents);\n    }, this);\n  }\n\n  bind() {\n    var gl = this.gl;\n    var materials = this.ctx.materials;\n\n    {\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n\n      gl.enableVertexAttribArray(materials.positionAttribLocation());\n      gl.vertexAttribPointer(materials.positionAttribLocation(), 3, gl.FLOAT, false, 0, 0);\n    }\n\n    {\n      gl.bindBuffer(gl.ARRAY_BUFFER, this.colorBuffer);\n\n      gl.enableVertexAttribArray(materials.colorAttribLocation());\n      gl.vertexAttribPointer(materials.colorAttribLocation(), 4, gl.UNSIGNED_BYTE, true, 0, 0);\n    }\n\n    this.texBuffers.forEach(function (buffer, index) {\n\n      gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\n\n      gl.enableVertexAttribArray(materials.texAttribLocation(index));\n      gl.vertexAttribPointer(materials.texAttribLocation(index),\n        this.texCoords[index].numComponents, gl.FLOAT, false, 0, 0);\n\n    }, this);\n\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.indicesBuffer);\n  }\n\n  shutdown() {\n    var gl = this.gl;\n\n    gl.deleteBuffer(this.positionBuffer);\n    gl.deleteBuffer(this.colorBuffer);\n\n    this.texBuffers.forEach(function (buffer) {\n      gl.deleteBuffer(buffer);\n    }, this);\n  }\n}"]}